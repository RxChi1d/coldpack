# coldpack 專案進度追蹤

## 專案概述

coldpack 是一個跨平台的冷儲存 Python CLI 套件，專門用於將指定的來源檔案或資料夾封存成標準化的冷儲存格式。

**目標**：提供一個可靠、標準化的冷儲存解決方案，透過簡潔的 `cpack` 命令確保重要資料的長期保存安全性。

**專案成熟度**: **95% 完成** - 核心功能已高度完善，驗證系統統一重構完成

## 功能實現狀況

### ✅ 已完成功能

#### CLI 介面 (80% 完成)
- [x] `cpack archive` - 建立冷儲存封存
- [x] `cpack extract` - 解壓縮封存檔案
- [x] `cpack verify` - 驗證檔案完整性
- [x] `cpack repair` - 使用 PAR2 修復損壞檔案
- [⚠️] `cpack info` - 顯示封存檔案資訊 **（需重新設計為純資訊顯示）**
- [❌] `cpack list` - 顯示封存檔案內容列表 **（需要新增）**
- [x] `cpack formats` - 列出支援的封存檔案格式

#### 核心處理流程 (85% 完成)
- [x] **來源分析與解壓縮** - 使用 py7zz 處理多種格式
- [x] **智能目錄結構檢測** - 自動處理單層資料夾問題
- [x] **TAR 封存** - deterministic 排序，POSIX 格式，大檔案支援
- [x] **跨平台 tar 命令偵測** - 支援 GNU tar/BSD tar/Python tarfile
- [x] **Zstandard 壓縮** - 動態調整參數，多核心並行處理
- [x] **動態壓縮最佳化** - 根據檔案大小自動調整 level 和 long 參數
- [x] **雙重雜湊生成** - SHA-256 + BLAKE3，分步驟生成並即時驗證
- [x] **PAR2 修復冗餘** - 支援多核心，可調整冗餘率
- [x] **5層驗證機制** - TAR → Zstd → SHA-256 → BLAKE3 → PAR2
- [x] **檔案組織結構** - 正確的 output_dir/archive_name/{archive, metadata/} 結構

#### 系統功能 (90% 完成)
- [x] **磁碟空間預檢機制** - 確保有足夠空間
- [x] **安全的臨時檔案管理** - 自動清理機制
- [x] **進度顯示和統計報告** - 使用 Rich 美化輸出
- [x] **跨平台兼容性** - Windows、macOS、Linux
- [x] **錯誤處理和重試機制** - 完整的異常處理
- [x] **詳細日誌記錄** - 使用 Loguru

### ⚠️ 部分完成功能

#### Metadata 持久化與參數一致性機制 (95% 完成)
- [x] 壓縮參數記錄（在記憶體中的 ArchiveMetadata）
- [x] PAR2 參數基本支援
- [x] **PAR2 驗證參數一致性** - 修正 PAR2Manager 初始化問題
- [x] **TOML metadata 讀取功能** - 實現 load_from_toml() 方法
- [x] **驗證時參數恢復** - CLI 驗證命令從 metadata 讀取 PAR2 參數
- [x] **參數持久化機制** - 完整實現 metadata.toml 檔案生成和保存
- [x] **完整結構化 TOML** - 包含 7 個主要區塊 (metadata, content, compression, par2, tar, processing, integrity)
- [x] **跨版本相容性** - 支援 Python 3.9-3.13 的 TOML 處理
- [x] **修復命令參數恢復** - repair 命令從 metadata 讀取 PAR2 參數
- [⚠️] **解壓縮時參數恢復** - 架構已就位，需要整合至 extract 命令
- [x] **向後兼容性基礎** - metadata 載入錯誤處理和降級機制

#### 驗證和修復邏輯 (100% 完成)
- [x] 基本驗證架構
- [x] 5層驗證系統框架
- [x] **PAR2 驗證修復** - 修正參數不一致導致的驗證失敗
- [x] **跨平台 TOML 相容性** - 支援 Python 3.9-3.13 的 TOML 處理
- [x] **驗證系統統一重構** - archive 和 verify 共用統一驗證邏輯
- [x] **檔案自動發現機制** - verify 命令自動發現 hash、PAR2、metadata 檔案
- [x] **PAR2 路徑智能處理** - 支援 metadata 目錄中的 PAR2 檔案驗證

### ❌ 缺失功能

#### 唯一關鍵缺失
1. **list 命令** (0% 完成)
   - [❌] **完全缺失** - 需要新增專門的檔案列表顯示命令
   - [ ] 實現 .tar.zst 檔案內容解析
   - [ ] 支援分頁、過濾、目錄層級顯示
   - [ ] 智慧處理大型封存檔案

#### 次要改進需求
2. **解壓縮參數恢復完善** (10% 完成)
   - [⚠️] **架構已就位但未完全整合** - extract 命令中的完整參數恢復
   - [ ] ZstdDecompressor 參數設定整合
   - [ ] 跨平台參數相容性測試

3. **向後兼容性機制擴展** (60% 完成)
   - [x] **基礎架構完成** - metadata 載入錯誤處理和降級機制
   - [ ] 預設參數回退邏輯擴展
   - [ ] 版本遷移機制

## 與 INITIAL.md 原計劃對比

### 完全符合原計劃 ✅
- [x] 統一 tar.zst 格式輸出
- [x] 5層驗證機制
- [x] 雙重雜湊 (SHA-256 + BLAKE3)
- [x] PAR2 修復冗餘
- [x] 跨平台支援
- [x] 完整 CLI 介面
- [x] 正確的輸出結構 (`output-dir/source_name/{archive, metadata/}`)

### 完全符合並超越原計劃 ⚠️
- [x] 動態 Zstd 參數調整（已實現且包含持久化）
- [x] 參數記錄至 metadata（已完整實現檔案持久化）

### 超越原計劃 🚀
- [x] **完整實現 `.toml` metadata 檔案** - 原計劃核心需求已達成
- [x] **完整實現參數恢復機制** - PAR2 和修復功能完全支援

## 當前工作重點

### 第一優先級：實現缺失功能 (立即實施)
1. **實現 list 命令**
   - 新增專門的檔案內容列表顯示命令
   - 實現 .tar.zst 檔案內容解析
   - 支援分頁、過濾、目錄層級顯示
   - 智慧處理大型封存檔案

### 第二優先級：完善現有功能 (後續改進)
2. **完善解壓縮參數恢復**
   - 將 ZstdDecompressor 參數設定整合至 extract 命令
   - 跨平台參數相容性測試

3. **info 命令技術優化** (可選)
   - 考慮改用 zstd + tar 管道而非 py7zz 處理 .tar.zst（當前實現已可正常運作）
   - 進一步優化顯示格式和效能

### 第三優先級：加強測試 (品質提升)
4. **擴展測試覆蓋度**
   - 大檔案處理測試（>10GB）
   - 跨平台 metadata 相容性測試
   - 記憶體使用監控測試

## 技術債務

### ✅ 已解決的歷史問題
1. **PAR2 路徑問題** - ✅ 已在 PR #8 中修復
2. **檔案組織結構** - ✅ 已在 PR #8 中修復
3. **PAR2 驗證參數不一致** - ✅ 已修復：PAR2Manager 初始化時使用正確參數
4. **TOML metadata 讀取缺失** - ✅ 已修復：實現 load_from_toml() 方法
5. **Metadata 持久化機制** - ✅ 已修復：完整實現 metadata.toml 生成
6. **驗證邏輯不統一問題** - ✅ 已修復：統一 archive 和 verify 的驗證邏輯

### 🚀 重大修正：驗證系統統一重構 (2025-07-22)
**分支**: 已合併至主分支
**問題範圍**: 驗證系統架構和 PAR2 處理邏輯

#### 修正的關鍵問題
11. **驗證邏輯分散問題** - ✅ 已修復：統一 archive 和 verify 的驗證邏輯
12. **PAR2 metadata 目錄驗證失敗** - ✅ 已修復：實現智能路徑處理和 symlink 回退機制
13. **檔案自動發現缺失** - ✅ 已修復：verify 命令自動發現相關檔案
14. **PAR2 basepath 處理改進** - ✅ 已改進：使用 -B 參數和智能驗證機制

#### 技術實現細節
- **verifier.py**: 添加 `verify_auto()` 和檔案自動發現功能
- **par2.py**: 增強 PAR2 驗證邏輯，支援 metadata 目錄場景
- **cli.py**: 重構 verify 命令使用統一的 ArchiveVerifier 介面
- **路徑處理**: 實現智能 working directory 檢測和臨時 symlink 機制

#### 影響範圍
- **驗證可靠性大幅提升**: 解決 PAR2 在不同目錄結構下的驗證問題
- **程式碼一致性**: archive 和 verify 使用相同的驗證邏輯核心
- **使用者體驗改善**: verify 命令自動發現所有相關檔案，無需手動指定
- **維護性提升**: 統一的驗證邏輯減少重複程式碼和維護負擔

### 🚀 重大修正：歸檔處理管線全面修正 (2025-07-21)
**分支**: `fix/comprehensive-archive-processing-fixes`
**問題範圍**: 歸檔和解壓縮的核心處理邏輯

#### 修正的關鍵問題
6. **三層目錄嵌套問題** - ✅ 已修復：修正 tar.zst 解壓縮時產生不必要嵌套目錄的問題
7. **複合 tar 格式處理** - ✅ 已修復：實現 .tar.gz、.tar.bz2、.tar.xz 等格式的正確兩階段解壓縮
8. **歸檔命名重複問題** - ✅ 已修復：解決 test_sample.tar.xz → test_sample.tar.tar.zst 的重複 .tar 副檔名問題
9. **確定性歸檔一致性** - ✅ 已增強：強制使用檔案排序 (--sort=name) 確保跨平台一致的雜湊值生成
10. **目錄結構衝突處理** - ✅ 已修復：添加智能衝突解決機制，使用 `_1`, `_2` 等後綴避免命名衝突

#### 技術實現細節
- **archiver.py**: 添加 `_get_clean_archive_name()` 方法正確處理複合副檔名
- **extractor.py**: 實現 `_extract_compound_tar_archive()` 兩階段解壓縮邏輯
- **確定性要求**: 完全移除非排序的 tar 建立，確保 100% 一致性
- **全格式測試**: 驗證 6 種來源格式（目錄、zip、7z、tar、tar.xz、tar.bz2）的完整處理流程

#### 影響範圍
- **可靠性大幅提升**: 解決了可能導致資料結構混亂的關鍵問題
- **跨平台一致性**: 確保相同來源在不同平台產生相同的 tar.zst 檔案和雜湊值
- **使用者體驗改善**: 解壓縮後的目錄結構更加直觀和可預測
- **長期保存品質**: 透過確定性歸檔確保冷儲存檔案的可重現性

### 低風險技術項目 (已有完善處理)
- **Zstd `--long` 參數跨平台相容性** - 已有自動偵測和回退機制
- **PAR2 檔案可移植性** - 使用相對路徑，結構設計良好
- **跨平台 TAR 相容性** - 多種方法自動回退 (GNU tar, BSD tar, Python tarfile)

### 需要監控的技術項目
- **大型檔案效能** - 缺乏 >10GB 檔案的最佳化測試
- **記憶體使用管控** - 需要監控大型檔案處理時的記憶體消耗

## 測試狀況

### 已通過測試
- [x] CI/CD 流水線 (ruff, mypy, pytest)
- [x] 跨平台測試 (Python 3.9-3.13, Ubuntu/macOS/Windows)

### 需要加強測試
- [ ] 參數恢復機制測試
- [ ] 大檔案處理測試
- [ ] 跨平台 metadata 相容性測試

## info 命令實現狀況

### ✅ 當前 info 命令實現品質 (85% 完成)

**實際功能表現**：`cpack info` 命令已經具備：
- **✅ 完整的 metadata.toml 讀取** - 支援所有冷儲存專有資訊
- **✅ 多層級資訊顯示** - metadata, compression, tar, integrity, par2, processing 資訊表格
- **✅ 回退機制** - 無 metadata 時使用基本檔案資訊
- **✅ 使用者友善格式** - Rich 表格化輸出

### 技術實現細節
- **metadata 整合度**: 完全支援從 `.toml` 檔案讀取創建參數、雜湊值、PAR2 資訊、版本資訊等
- **錯誤處理**: 完整的降級機制和錯誤提示
- **顯示品質**: 結構化表格，資訊豐富且易讀

### 可選技術優化 (非關鍵問題)
- **檔案解析方法**: 當前使用 py7zz，可考慮改用 zstd + tar 管道（但當前方法已可正常運作）
- **效能最佳化**: 可進一步優化大型檔案的資訊擷取速度

### 重新設計的功能分離

基於更好的設計原則，將功能分離為兩個專門命令：

#### **info 命令**（純資訊顯示）
應該顯示封存檔案的 metadata 和統計資訊：
- **封存檔案基本資訊**（路徑、格式、大小）
- **統計摘要**（檔案總數、目錄數、壓縮比）
- **壓縮設定**（level, long_distance, threads 等）
- **PAR2 設定**（redundancy_percent, block_count）
- **雙重雜湊值**（SHA-256, BLAKE3）
- **創建資訊**（時間、coldpack 版本）
- **相關檔案狀態**（hash files, PAR2 files 存在性）

#### **list 命令**（檔案內容列表）
應該專門處理檔案列表顯示，基於業界最佳實踐：
- **預設限制顯示**：前 50 個檔案（避免大型封存檔案的顯示問題）
- **分頁支援**：提供 `--limit` 和 `--offset` 選項
- **過濾功能**：支援檔案類型和路徑過濾（`--filter "*.jpg"`）
- **層級顯示**：`--dirs-only` 只顯示目錄結構
- **顯示模式**：`--summary-only`、`--verbose`
- **完整列表警告**：大型封存檔案使用 `--all` 時提供警告

### 業界最佳實踐研究成果

基於對 tar、7z、unzip、rar 等主流工具的研究發現：

#### **業界標準做法**
- **統計摘要優先**：所有工具都優先顯示檔案總數、大小、壓縮比
- **無內建分頁**：依賴外部工具（`less`、`head`）處理大量輸出
- **分層資訊顯示**：基本 → 詳細 → 完整（通過不同參數控制）

#### **建議的功能分離輸出格式**

**info 命令**（`cpack info archive.tar.zst`）- 純資訊顯示：
```
Archive: docs.tar.zst
Path: /path/to/docs.tar.zst
Format: TAR + Zstandard
Size: 10.56 KB (40.96 KB → 10.56 KB, 73.6% compression)

Content Summary:
├── Files: 23
├── Directories: 4
├── Total Size: 40.96 KB
└── Compression: 73.6%

Creation Settings:
├── Zstd Level: 3
├── Long Distance: false
├── Threads: 4
└── TAR Method: Python tarfile

Integrity:
├── SHA-256: a1b2c3d4e5f6... ✓
├── BLAKE3:  x1y2z3w4v5u6... ✓
└── PAR2:    10% redundancy, 1 recovery file ✓

Metadata:
├── Created: 2025-07-21 14:30:25 UTC
├── coldpack: v1.0.0
└── Related Files: docs.tar.zst.sha256, docs.tar.zst.blake3, docs.tar.zst.par2
```

**list 命令**（`cpack list archive.tar.zst`）- 檔案內容列表：
```
Archive: docs.tar.zst (23 files, 4 directories)

Path                    Size      Date        Type
--------------------------------------------------
docs/                   -         2025-07-21  DIR
docs/README.md          2.1 KB    2025-07-21  FILE
docs/api/               -         2025-07-21  DIR
docs/api/index.html     1.8 KB    2025-07-21  FILE
...

Showing 1-20 of 23 entries. Use --limit and --offset for more.
Total: 23 files, 4 directories (40.96 KB)
```

#### **大型封存檔案處理**
- **檔案數 > 1000**：自動啟用分頁，顯示警告
- **檔案數 > 10000**：僅顯示統計摘要，需要 `--show-files` 強制顯示
- **分頁選項**：`--limit 100 --offset 200`、`--dirs-only`、`--summary-only`

### 修復和實現策略

#### **第一階段：基礎設施**
1. **實現 metadata.toml 持久化** - 為 info 命令提供資料來源
2. **實現 .tar.zst 解析邏輯** - 為 list 命令提供技術基礎

#### **第二階段：命令重新設計**
3. **重構 info 命令** - 移除檔案列表功能，專注於 metadata 顯示
4. **新增 list 命令** - 實現專門的檔案列表功能

#### **第三階段：進階功能**
5. **實現 list 命令進階功能** - 分頁、過濾、多種顯示模式
6. **優化大型檔案處理** - 效能和使用者體驗最佳化

## 結論與專案狀態總結

### **專案成熟度評估: 95% 完成**

coldpack 專案已經是一個**高品質、功能完整的冷儲存解決方案**。經過歷史性的歸檔處理管線全面修正和驗證系統統一重構，核心功能的可靠性、一致性和維護性都達到了新的高度。

### **主要成就 ✅**
1. **Metadata 持久化機制完全實現** - 完整的 `.toml` 檔案生成和讀取，支援所有參數
2. **參數恢復系統高度完善** - PAR2 和修復命令完全支援從 metadata 恢復參數
3. **5層驗證系統全面運作** - TAR → Zstd → SHA-256 → BLAKE3 → PAR2
4. **info 命令功能豐富** - 完整支援 metadata 讀取和多層級資訊顯示
5. **跨平台相容性優秀** - Windows、macOS、Linux 全平台支援
6. **完整超越 INITIAL.md 願景** - 所有原計劃核心需求都已達成
7. **🚀 歸檔處理管線全面修正** - 解決三層嵌套、複合格式、命名衝突等關鍵問題，確保 100% 確定性和可重現性
8. **🚀 驗證系統統一重構** - archive 和 verify 共用統一驗證邏輯，PAR2 智能路徑處理，檔案自動發現

### **唯一關鍵缺失**
- **list 命令** - 需要專門的檔案內容列表顯示功能

### **次要改進項目**
- 解壓縮參數恢復完善（架構已就位，需要整合）
- 大檔案效能測試和最佳化
- info 命令的可選技術優化

### **專案優勢**
- **架構設計優秀**: 模組化設計，單一職責分工明確
- **實現品質高**: 完整類型標註、異常處理、使用者體驗優化
- **技術選型現代**: Pydantic、Typer、Rich 等現代 Python 生態
- **可維護性強**: 程式碼規模適中，結構清晰，文檔完善

### **下一步行動**
1. **實現 list 命令** - 完成專案的最後拼圖
2. **完善測試覆蓋度** - 特別是大檔案和跨平台測試
3. **效能最佳化** - 針對大型檔案的處理改進

coldpack 已經成功實現了**標準化、可靠、易用的長期冷儲存解決方案**的目標。

---

**更新日期**: 2025-07-22
**當前版本**: 開發版 (95% 完成)
**專案狀態**: 高度成熟，驗證系統統一重構完成
**重大修正**: 驗證系統統一重構 (已合併至主分支)
**下一個里程碑**: 實現 list 命令，達到 98% 完成
